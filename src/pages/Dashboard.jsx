import { useNavigate } from 'react-router-dom'
import {
  Container,
  Box,
  Card,
  CardContent,
  Button,
  Typography,
  Avatar,
  Grid,
  Paper,
  Divider,
} from '@mui/material'
import { LogOut, User, CreditCard, Phone, MapPin, Home as HomeIcon, Crown, Calculator, DollarSign } from 'lucide-react'
import useAuthStore from '../store/authStore'
import RoleBadge from '../components/RoleBadge'
import RequirePermission from '../components/RequirePermission'
import { PERMISSIONS } from '../constants/roles'

function Dashboard() {
  const navigate = useNavigate()
  const { user, signOut } = useAuthStore()

  const handleSignOut = () => {
    signOut()
    navigate('/signin')
  }

  return (
    <Container maxWidth="lg">
      <Box sx={{ minHeight: '100vh', py: 4 }}>
        {/* Header Card - Th√¥ng tin ng∆∞·ªùi d√πng */}
        <Card sx={{ boxShadow: 3, mb: 3 }}>
          <CardContent sx={{ p: 4 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: 2 }}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                <Avatar
                  sx={{
                    width: 80,
                    height: 80,
                    bgcolor: 'primary.main',
                  }}
                >
                  <User size={40} />
                </Avatar>
                
                <Box>
                  <Typography variant="h5" fontWeight="bold" gutterBottom>
                    {user?.fullName || 'Ng∆∞·ªùi d√πng'}
                  </Typography>
                  <RoleBadge role={user?.role} />
                </Box>
              </Box>

              <Button
                variant="contained"
                color="error"
                startIcon={<LogOut size={20} />}
                onClick={handleSignOut}
              >
                ƒêƒÉng Xu·∫•t
              </Button>
            </Box>

            <Divider sx={{ my: 3 }} />

            {/* Th√¥ng tin c√° nh√¢n */}
            <Grid container spacing={3}>
              <Grid item xs={12} sm={6} md={3}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>
                  <CreditCard size={20} color="#666" />
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      S·ªë cƒÉn c∆∞·ªõc
                    </Typography>
                    <Typography variant="body1" fontWeight="600">
                      {user?.citizenId || 'N/A'}
                    </Typography>
                  </Box>
                </Box>
              </Grid>

              <Grid item xs={12} sm={6} md={3}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>
                  <Phone size={20} color="#666" />
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      S·ªë ƒëi·ªán tho·∫°i
                    </Typography>
                    <Typography variant="body1" fontWeight="600">
                      {user?.phoneNumber || 'N/A'}
                    </Typography>
                  </Box>
                </Box>
              </Grid>

              <Grid item xs={12} sm={6} md={3}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>
                  <MapPin size={20} color="#666" />
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      ƒê·ªãa ch·ªâ
                    </Typography>
                    <Typography variant="body1" fontWeight="600">
                      {user?.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}
                    </Typography>
                  </Box>
                </Box>
              </Grid>

              <Grid item xs={12} sm={6} md={3}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>
                  <HomeIcon size={20} color="#666" />
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      M√£ h·ªô gia ƒë√¨nh
                    </Typography>
                    <Typography variant="body1" fontWeight="600">
                      {user?.householdId || 'Ch∆∞a c√≥'}
                    </Typography>
                  </Box>
                </Box>
              </Grid>
            </Grid>
          </CardContent>
        </Card>

        {/* Ch·ª©c nƒÉng ch√≠nh */}
        <Typography variant="h5" fontWeight="bold" sx={{ mb: 2 }}>
          Ch·ª©c nƒÉng ch√≠nh
        </Typography>
        
        <Grid container spacing={3} sx={{ mb: 3 }}>
          {/* T·ªï D√¢n Ph·ªë - Full quy·ªÅn */}
          <RequirePermission permission={PERMISSIONS.MANAGE_USERS}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', bgcolor: 'error.50', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <Crown size={28} color="#d32f2f" />
                    <Typography variant="h6" color="error" fontWeight="bold">
                      Qu·∫£n l√Ω to√†n b·ªô
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Qu·∫£n l√Ω ng∆∞·ªùi d√πng, ph√¢n quy·ªÅn, c√†i ƒë·∫∑t h·ªá th·ªëng v√† to√†n b·ªô d√¢n ph·ªë
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>

          {/* Ki·ªÉm To√°n - Qu·∫£n l√Ω t√†i ch√≠nh */}
          <RequirePermission permission={PERMISSIONS.AUDIT_FINANCE}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', bgcolor: 'warning.50', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <Calculator size={28} color="#ed6c02" />
                    <Typography variant="h6" color="warning.main" fontWeight="bold">
                      Ki·ªÉm to√°n t√†i ch√≠nh
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Qu·∫£n l√Ω c√°c kho·∫£n thu chi, ki·ªÉm to√°n s·ªï s√°ch t√†i ch√≠nh c·ªßa d√¢n ph·ªë
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>

          {/* Ch·ªß H·ªô - Qu·∫£n l√Ω h·ªô gia ƒë√¨nh */}
          <RequirePermission permission={PERMISSIONS.MANAGE_HOUSEHOLD_MEMBERS}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', bgcolor: 'info.50', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <HomeIcon size={28} color="#0288d1" />
                    <Typography variant="h6" color="info.main" fontWeight="bold">
                      Qu·∫£n l√Ω h·ªô gia ƒë√¨nh
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Qu·∫£n l√Ω th√¥ng tin c√°c th√†nh vi√™n trong h·ªô v√† c√°c kho·∫£n ƒë√≥ng g√≥p
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>

          {/* Xem th√¥ng tin c√° nh√¢n - T·∫•t c·∫£ */}
          <RequirePermission permission={PERMISSIONS.VIEW_OWN_INFO}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <User size={28} color="#1976d2" />
                    <Typography variant="h6" color="primary" fontWeight="bold">
                      Th√¥ng tin c·ªßa t√¥i
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Xem v√† c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n c·ªßa b·∫°n
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>

          {/* Xem th√¥ng b√°o - T·∫•t c·∫£ */}
          <RequirePermission permission={PERMISSIONS.VIEW_ANNOUNCEMENTS}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <Typography variant="h4">üì¢</Typography>
                    <Typography variant="h6" color="primary" fontWeight="bold">
                      Th√¥ng b√°o
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Xem c√°c th√¥ng b√°o v√† tin t·ª©c t·ª´ t·ªï d√¢n ph·ªë
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>

          {/* ƒê√≥ng g√≥p - Ch·ªß h·ªô v√† C∆∞ d√¢n */}
          <RequirePermission permission={PERMISSIONS.VIEW_CONTRIBUTIONS}>
            <Grid item xs={12} md={6} lg={4}>
              <Card sx={{ height: '100%', cursor: 'pointer', '&:hover': { boxShadow: 4 } }}>
                <CardContent>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 2 }}>
                    <DollarSign size={28} color="#1976d2" />
                    <Typography variant="h6" color="primary" fontWeight="bold">
                      Kho·∫£n ƒë√≥ng g√≥p
                    </Typography>
                  </Box>
                  <Typography variant="body2" color="text.secondary">
                    Xem v√† thanh to√°n c√°c kho·∫£n ƒë√≥ng g√≥p c·ªßa h·ªô gia ƒë√¨nh
                  </Typography>
                </CardContent>
              </Card>
            </Grid>
          </RequirePermission>
        </Grid>

        {/* Th√¥ng tin quy·ªÅn h·∫°n */}
        <Card sx={{ boxShadow: 2 }}>
          <CardContent>
            <Typography variant="h6" gutterBottom fontWeight="bold">
              üîê Quy·ªÅn h·∫°n c·ªßa b·∫°n
            </Typography>
            <Grid container spacing={2} sx={{ mt: 1 }}>
              <RequirePermission permission={PERMISSIONS.VIEW_ALL_CITIZENS}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'background.default' }}>
                    <Typography variant="body2" color="primary" fontWeight="600">
                      ‚úì Xem t·∫•t c·∫£ c∆∞ d√¢n
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.MANAGE_HOUSEHOLD_MEMBERS}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'background.default' }}>
                    <Typography variant="body2" color="info.main" fontWeight="600">
                      ‚úì Qu·∫£n l√Ω th√†nh vi√™n h·ªô
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.AUDIT_FINANCE}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'warning.50' }}>
                    <Typography variant="body2" color="warning.main" fontWeight="600">
                      ‚úì Ki·ªÉm to√°n t√†i ch√≠nh
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.VIEW_ALL_FINANCES}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'background.default' }}>
                    <Typography variant="body2" color="primary" fontWeight="600">
                      ‚úì Xem t·∫•t c·∫£ t√†i ch√≠nh
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.CREATE_ANNOUNCEMENT}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'background.default' }}>
                    <Typography variant="body2" color="primary" fontWeight="600">
                      ‚úì T·∫°o th√¥ng b√°o
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.PAY_CONTRIBUTION}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'background.default' }}>
                    <Typography variant="body2" color="success.main" fontWeight="600">
                      ‚úì Thanh to√°n ƒë√≥ng g√≥p
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.MANAGE_ROLES}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'error.50' }}>
                    <Typography variant="body2" color="error" fontWeight="600">
                      ‚úì Qu·∫£n l√Ω ph√¢n quy·ªÅn
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>

              <RequirePermission permission={PERMISSIONS.SYSTEM_SETTINGS}>
                <Grid item xs={12} sm={6} md={4}>
                  <Paper sx={{ p: 2, bgcolor: 'error.50' }}>
                    <Typography variant="body2" color="error" fontWeight="600">
                      ‚úì C√†i ƒë·∫∑t h·ªá th·ªëng
                    </Typography>
                  </Paper>
                </Grid>
              </RequirePermission>
            </Grid>
          </CardContent>
        </Card>
      </Box>
    </Container>
  )
}

export default Dashboard