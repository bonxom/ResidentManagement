<!DOCTYPE html>
<html>
<head>
    <title>Debug Chat Issue</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; max-height: 500px; overflow-y: auto; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .user-info { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
        .message-info { margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 3px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Chat Issue</h1>
    
    <button onclick="fullDebug()">Full Debug Analysis</button>
    <button onclick="checkCurrentSession()">Ki·ªÉm tra Session Hi·ªán T·∫°i</button>
    <button onclick="testSendMessage()">Test G·ª≠i Tin Nh·∫Øn</button>
    <button onclick="clearAllData()">Clear All Data & Logout</button>
    
    <div id="result"></div>
    
    <script>
        const resultDiv = document.getElementById('result');
        
        async function fullDebug() {
            resultDiv.innerHTML = '<p>üîÑ ƒêang th·ª±c hi·ªán full debug...</p>';
            
            try {
                let html = '<div class="result info"><h3>üîç FULL DEBUG ANALYSIS</h3>';
                
                // 1. Ki·ªÉm tra localStorage
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = localStorage.getItem('token');
                
                html += '<h4>1. üì± LocalStorage Data:</h4>';
                html += `<div class="user-info">
                    <strong>User Name:</strong> ${user.name || 'N/A'}<br>
                    <strong>User Email:</strong> ${user.email || 'N/A'}<br>
                    <strong>User ID:</strong> ${user._id || 'N/A'}<br>
                    <strong>User Role:</strong> ${user.role?.role_name || 'N/A'}<br>
                    <strong>Token exists:</strong> ${!!token}<br>
                    <strong>Token preview:</strong> ${token ? token.substring(0, 20) + '...' : 'N/A'}
                </div>`;
                
                // 2. Ki·ªÉm tra server session
                html += '<h4>2. üîê Server Session Check:</h4>';
                try {
                    const meResponse = await fetch('http://localhost:3000/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (meResponse.ok) {
                        const serverUser = await meResponse.json();
                        html += `<div class="user-info success">
                            <strong>Server User Name:</strong> ${serverUser.name || 'N/A'}<br>
                            <strong>Server User Email:</strong> ${serverUser.email || 'N/A'}<br>
                            <strong>Server User ID:</strong> ${serverUser._id || 'N/A'}<br>
                            <strong>Server User Role:</strong> ${serverUser.role?.role_name || 'N/A'}
                        </div>`;
                        
                        // So s√°nh localStorage vs server
                        if (user._id !== serverUser._id) {
                            html += '<div class="warning">‚ö†Ô∏è <strong>MISMATCH:</strong> LocalStorage user ID kh√°c v·ªõi server user ID!</div>';
                        }
                        if (user.name !== serverUser.name) {
                            html += '<div class="warning">‚ö†Ô∏è <strong>MISMATCH:</strong> LocalStorage user name kh√°c v·ªõi server user name!</div>';
                        }
                    } else {
                        html += '<div class="error">‚ùå Kh√¥ng th·ªÉ l·∫•y th√¥ng tin user t·ª´ server (Token c√≥ th·ªÉ h·∫øt h·∫°n)</div>';
                    }
                } catch (error) {
                    html += `<div class="error">‚ùå L·ªói k·∫øt n·ªëi server: ${error.message}</div>`;
                }
                
                // 3. Ki·ªÉm tra tin nh·∫Øn g·∫ßn ƒë√¢y
                html += '<h4>3. üí¨ Recent Messages Analysis:</h4>';
                try {
                    const debugResponse = await fetch('http://localhost:3000/api/chat/debug-messages');
                    if (debugResponse.ok) {
                        const debugData = await debugResponse.json();
                        
                        html += `<p><strong>T·ªïng s·ªë tin nh·∫Øn:</strong> ${debugData.messages.length}</p>`;
                        
                        debugData.messages.slice(0, 5).forEach((msg, index) => {
                            html += `<div class="message-info">
                                <strong>Tin nh·∫Øn ${index + 1}:</strong> "${msg.content}"<br>
                                <strong>Sender Name:</strong> ${msg.sender?.name || 'N/A'}<br>
                                <strong>Sender Email:</strong> ${msg.sender?.email || 'N/A'}<br>
                                <strong>Sender ID:</strong> ${msg.sender?._id || 'N/A'}<br>
                                <strong>Time:</strong> ${new Date(msg.createdAt).toLocaleString()}
                            </div>`;
                        });
                        
                        // T√¨m tin nh·∫Øn c·ªßa user hi·ªán t·∫°i
                        const myMessages = debugData.messages.filter(msg => msg.sender?._id === user._id);
                        html += `<p><strong>Tin nh·∫Øn c·ªßa b·∫°n:</strong> ${myMessages.length} tin nh·∫Øn</p>`;
                        
                        if (myMessages.length > 0) {
                            const latestMyMessage = myMessages[0];
                            html += `<div class="warning">
                                <strong>Tin nh·∫Øn m·ªõi nh·∫•t c·ªßa b·∫°n:</strong><br>
                                Content: "${latestMyMessage.content}"<br>
                                Hi·ªÉn th·ªã t√™n: ${latestMyMessage.sender?.name}<br>
                                Actual email: ${latestMyMessage.sender?.email}
                            </div>`;
                        }
                    }
                } catch (error) {
                    html += `<div class="error">‚ùå Kh√¥ng th·ªÉ l·∫•y debug messages: ${error.message}</div>`;
                }
                
                // 4. Ki·ªÉm tra t·∫•t c·∫£ users
                html += '<h4>4. üë• All Users in Database:</h4>';
                try {
                    const debugResponse = await fetch('http://localhost:3000/api/chat/debug-messages');
                    if (debugResponse.ok) {
                        const debugData = await debugResponse.json();
                        
                        debugData.users.forEach(dbUser => {
                            const isCurrentUser = dbUser._id === user._id;
                            html += `<div class="user-info ${isCurrentUser ? 'warning' : ''}">
                                ${isCurrentUser ? 'üë§ <strong>THIS IS YOU:</strong><br>' : ''}
                                <strong>Name:</strong> ${dbUser.name}<br>
                                <strong>Email:</strong> ${dbUser.email}<br>
                                <strong>ID:</strong> ${dbUser._id}<br>
                                <strong>Role:</strong> ${dbUser.role}
                            </div>`;
                        });
                    }
                } catch (error) {
                    html += `<div class="error">‚ùå Kh√¥ng th·ªÉ l·∫•y user list: ${error.message}</div>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Debug Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function checkCurrentSession() {
            resultDiv.innerHTML = '<p>üîÑ ƒêang ki·ªÉm tra session...</p>';
            
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            let html = '<div class="result info"><h3>üîê Current Session</h3>';
            html += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
            html += `<p><strong>Token:</strong> ${token ? 'EXISTS' : 'MISSING'}</p>`;
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }
        
        async function testSendMessage() {
            resultDiv.innerHTML = '<p>üîÑ Testing send message...</p>';
            
            try {
                const token = localStorage.getItem('token');
                const testMessage = `Test message at ${new Date().toLocaleTimeString()}`;
                
                const response = await fetch('http://localhost:3000/api/chat/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: testMessage,
                        replyTo: null
                    })
                });
                
                if (response.ok) {
                    const sentMessage = await response.json();
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>‚úÖ Test Message Sent</h3>
                            <p><strong>Content:</strong> ${sentMessage.content}</p>
                            <p><strong>Sender Name:</strong> ${sentMessage.sender?.name}</p>
                            <p><strong>Sender Email:</strong> ${sentMessage.sender?.email}</p>
                            <p><strong>Sender ID:</strong> ${sentMessage.sender?._id}</p>
                            <p><strong>Role:</strong> ${sentMessage.sender?.role?.role_name}</p>
                            
                            <h4>Raw Response:</h4>
                            <pre>${JSON.stringify(sentMessage, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>‚ùå Send Message Failed</h3>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${errorData}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Test Send Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function clearAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu v√† ƒëƒÉng xu·∫•t?')) {
                localStorage.clear();
                sessionStorage.clear();
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu</h3>
                        <p>T·∫•t c·∫£ localStorage v√† sessionStorage ƒë√£ ƒë∆∞·ª£c x√≥a.</p>
                        <p><a href="http://localhost:5174" target="_blank">ƒêƒÉng nh·∫≠p l·∫°i t·∫°i ƒë√¢y</a></p>
                    </div>
                `;
            }
        }
        
        // Auto run full debug
        window.onload = function() {
            setTimeout(fullDebug, 1000);
        };
    </script>
</body>
</html>